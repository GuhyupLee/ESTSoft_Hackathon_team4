<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>기억나래 : 인지력 향상 퀴즈</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Chart.js 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation 플러그인 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <script>
        let mediaRecorder;
        let chunks = [];
        let accuracyData = [];
        let chart;

        async function startQuestion() {
            const response = await fetch("/start");
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();
        }

        async function startRecording() {
            chunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            mediaRecorder.ondataavailable = (e) => {
                chunks.push(e.data);
            };
            mediaRecorder.onstop = async (e) => {
                const recordingBlob = new Blob(chunks, { type: "audio/mpeg" });
                const formData = new FormData();
                formData.append("file", recordingBlob, "input.mp3");
                const response = await fetch("/answer", {
                    method: "POST",
                    body: formData,
                });
                const responseAudioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(responseAudioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                await updateAccuracy();  // 정확도 업데이트 함수 호출
            };
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // 정확도 데이터를 서버에서 가져와 차트와 정확도 표시를 업데이트하는 함수
        async function updateAccuracy() {
            const response = await fetch("/accuracy");
            const result = await response.json();
            const accuracy = parseFloat(result.accuracy.toFixed(2));
            document.getElementById("accuracy").textContent = `정답률: ${accuracy}%`;

            // 서버에서 최신 정확도 데이터 가져오기
            const accuracyDataResponse = await fetch("/accuracy_data");
            accuracyData = await accuracyDataResponse.json();

            const ctx = document.getElementById("accuracy-chart").getContext("2d");

            if (chart) {
                chart.data.labels = accuracyData.map((_, index) => index + 1);
                chart.data.datasets[0].data = accuracyData;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: accuracyData.map((_, index) => index + 1),
                        datasets: [{
                            label: "정답률",
                            data: accuracyData,
                            borderColor: "rgba(75, 192, 192, 1)",
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 75,
                                        yMax: 75,
                                        borderColor: 'red',
                                        borderWidth: 2,
                                        label: {
                                            content: '나이대 평균 점수',
                                            enabled: true,
                                            position: 'center'
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // 사용자 데이터를 서버에서 가져오는 함수
        async function loadUserData() {
            const response = await fetch("/user_data");
            const userData = await response.json();
            document.getElementById("name").textContent = userData.Name;
            document.getElementById("age").textContent = userData.Age;
        }

        // 페이지 로드 시 최신 사용자 데이터와 정확도 데이터를 서버에서 가져오는 부분
        window.onload = async function() {
            await loadUserData();  // 사용자 데이터 로드
            await updateAccuracy();  // 정확도 데이터 로드 및 업데이트
        };
    </script>
</head>
<body>
    <header>
        <h1>두뇌 트레이닝 앱</h1>
    </header>
    <main>
        <section id="user-info">
            <p><strong>이름:</strong> <span id="name"></span></p>
            <p><strong>나이:</strong> <span id="age"></span></p>
        </section>
        <section id="question-section">
            <button id="start-question" onclick="startQuestion()">문제 듣기</button>
            <button id="record-button" onclick="toggleRecording()">
                <i class="fas fa-microphone"></i>
            </button>
        </section>
        <section id="result-section">
            <p id="accuracy">정답률: 0%</p>
            <canvas id="accuracy-chart"></canvas>
        </section>
    </main>
</body>
</html>
